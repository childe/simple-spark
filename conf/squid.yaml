app_name: squid
master: spark://10.8.84.130:7077
#master: local[3]
spark_conf:
    spark.cores.max: "4"
    spark.executor.memory: 2g
    spark.ui.port: "8100"
batching_interval: 10
input:
  kafka:
    squid:
      zookeeper: 10.8.84.74:2181
      groupID: spark-opsdev-test-liujia-201505132251
      topics:
        logstash-opslinuxlog-squid-proxy: 2

function:
#  - Split:
#      id: split
#      from: squid
#      #1427965391.659     29 10.8.74.48[-] TCP_MISS/500 150 513 GET http://www.weather.com.cn/weather/%E5%8B%83%E5%88%A9.shtml - HIER_DIRECT/180.97.161.108 text/html 500 -
#      delimiter: '\s+|/'
#      fields:
#        logtime: 1
#        responseTime: 2
#        requestStatusCode: 5
#        domain: 11
  - Grok:
      id: grok
      from: squid
      match:
        - message: ['\s*(?<logtime>\S+)\s+(?<responseTime>\d+)\s+\S+[^/]+/(?<requestStatusCode>\d+)(\s+\S+){3}\s+(.*://)?(?<domain>[^/:]+)']
  - Filter:
      id: domain
      from: grok
      if:
        - '{{event[1].domain in [ "api.weixin.qq.com", "114.251.242.52", "121.196.130.160", "220.196.50.222", "api.travelfusion.com", "distribution-xml.booking.com", "espeed.travelsky.com", "gw.api.taobao.com", "gw.tenpay.com", "gw.tuan.jd.com", "hte.hilton.com", "interface.4006695539.com", "mapi.alipay.com", "query.unionpaysecure.com", "restapi.amap.com", "sdk2.entinfo.cn", "uniteorder.juneyaoair.com", "webservices.sabre.com", "www.variflight.com", "xml.agoda.com"] }}'
  - Setkey:
      id: setkey_proxy
      from: grok
      key: ["{{event[1].proxy_name}}", "{{event[1].logtime|integer - event[1].logtime|integer%120}}"]
  - Setkey:
      id: setkey_domain
      from: domain
      key: ["{{event[1].domain}}", "{{event[1].logtime|integer - event[1].logtime|integer%120}}"]
  - union:
      id: union
      from: setkey_domain
      right: ['setkey_proxy']
  - Stat:
      id: firststat
      from: union
      field: responseTime
  - window:
      id: window
      from: firststat
      transform_args: [600,120]
  - Stat:
      id: stat
      from: window
      field: responseTime
  - Filter:
      id: responseTime_out
      from: stat
      if:
        - "{{event[0][1]|int + 600 >= ''|nowtime/1000}}"
        - "{{event[0][1]|int + 120 <= ''|nowtime/1000}}"

  - Setkey:
      from: grok
      id: setkey_proxy_name_if_200
      key: ["{{event[1].proxy_name}}", "{{event[1].requestStatusCode == '200'}}", "{{event[1].logtime|integer - event[1].logtime|integer%120}}"]
  - Setkey:
      from: domain
      id: setkey_domain_if_200
      key: ["{{event[1].domain}}", "{{event[1].requestStatusCode == '200'}}", "{{event[1].logtime|integer - event[1].logtime|integer%120}}"]
  - union:
      from: setkey_domain_if_200
      id: union_200
      right: ['setkey_proxy_name_if_200']
  - Count:
      from: union_200
      id: first_count_200
      transformation: reduceByKey
  - window:
      from: first_count_200
      id: window_200
      transform_args: [600,120]
  - Filter:
      from: window_200
      id: count_200
      id: count_out
      transformation: filter
      if: 
        - "{{event[0][2]|int + 600 >= ''|nowtime/1000}}"
        - "{{event[0][2]|int + 120 <= ''|nowtime/1000}}"
output:
  - Tcp:
      from: responseTime_out
      host: 192.168.18.85
      port: 2003
      format:
        - 'test.squid.proxy.domain.{{event[0][0]|replace(".","_")}}.count {{event[1].responseTime_count|default(1)}} {{event[0][1]}}'
        - 'test.squid.proxy.domain.{{event[0][0]|replace(".","_")}}.responseTime {{event[1].responseTime_sum|default(event[1].responseTime)/event[1].responseTime_count|default(1)}} {{event[0][1]}}'
        - 'test.squid.proxy.domain.{{event[0][0]|replace(".","_")}}.responseTime_sum {{event[1].responseTime_sum}} {{event[0][1]}}'
  - Tcp:
      from: count_out
      host: 192.168.18.85
      port: 2003
      format:
        - 'test.squid.proxy.domain.{{event[0][0]|replace(".","_")}}.{%if event[0][1]!="true"%}non_{%endif%}200_count {{event[1]["count"]|default(1)}} {{event[0][2]}}'
